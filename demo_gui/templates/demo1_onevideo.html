<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo1 - 力控夹薯片演示</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-hover {
                @apply transition-all duration-300 transform hover:scale-105 hover:shadow-lg;
            }
            .card-effect {
                @apply bg-white rounded-xl shadow-md hover:shadow-xl transition-shadow duration-300;
            }
            .status-running {
                @apply bg-green-100 text-green-800 border-green-200;
            }
            .status-stopped {
                @apply bg-gray-100 text-gray-800 border-gray-200;
            }
            .status-error {
                @apply bg-red-100 text-red-800 border-red-200;
            }
            .status-initializing {
                @apply bg-yellow-100 text-yellow-800 border-yellow-200;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 页面标题 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-dark mb-2">Demo1 - 力控夹薯片演示</h1>
            <p class="text-gray-600">基于力传感器的智能夹取控制系统</p>
        </header>

        <!-- 控制面板 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 控制按钮区域 -->
            <div class="card-effect p-6">
                <h2 class="text-xl font-semibold mb-4 text-dark">
                    <i class="fa fa-cogs mr-2 text-primary"></i>控制面板
                </h2>
                
                <div class="space-y-4">
                    <button id="startBtn" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 px-6 rounded-lg btn-hover disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-play mr-2"></i>启动 Demo1
                    </button>
                    
                    <button id="stopBtn" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg btn-hover disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-stop mr-2"></i>停止 Demo1
                    </button>
                    
                    <button id="refreshBtn" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg btn-hover">
                        <i class="fa fa-refresh mr-2"></i>刷新状态
                    </button>
                </div>
            </div>

            <!-- 状态显示区域 -->
            <div class="card-effect p-6">
                <h2 class="text-xl font-semibold mb-4 text-dark">
                    <i class="fa fa-info-circle mr-2 text-accent"></i>运行状态
                </h2>
                
                <div class="space-y-4">
                    <div class="border rounded-lg p-4" id="statusCard">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">当前状态:</span>
                            <span id="statusBadge" class="px-3 py-1 rounded-full text-sm font-medium border status-stopped">
                                未启动
                            </span>
                        </div>
                        <div class="text-sm text-gray-600" id="statusMessage">
                            Demo1 尚未启动
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <div>最后更新: <span id="lastUpdate">--</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二行：功能说明和实时相机画面 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 左侧：功能说明 -->
            <div class="card-effect p-6">
                <h2 class="text-xl font-semibold mb-4 text-dark">
                    <i class="fa fa-lightbulb-o mr-2 text-amber-500"></i>功能说明
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                    <div>
                        <h3 class="font-medium mb-2">演示内容:</h3>
                        <ul class="space-y-1 list-disc list-inside">
                            <li>力传感器实时监测</li>
                            <li>智能夹爪位置控制</li>
                            <li>外力检测与响应</li>
                            <li>自适应抓取算法</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">技术特点:</h3>
                        <ul class="space-y-1 list-disc list-inside">
                            <li>24×32 力传感器阵列</li>
                            <li>100Hz 高频控制循环</li>
                            <li>多轴力学建模</li>
                            <li>动态阈值调整</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 右侧：实时相机画面 -->
            <div class="card-effect p-6">
                <h2 class="text-xl font-semibold mb-4 text-dark">
                    <i class="fa fa-video-camera mr-2 text-blue-500"></i>实时相机画面
                </h2>
                
                <div class="space-y-4">
                    <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="aspect-ratio: 4/3;">
                        <img id="cameraFrame" 
                             src="/api/camera/stream" 
                             alt="实时相机画面"
                             class="w-full h-full object-cover"
                             style="display: none;">
                        <div id="cameraPlaceholder" 
                             class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <i class="fa fa-video-camera text-4xl mb-2"></i>
                                <p>相机画面加载中...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 相机控制按钮 -->
                    <div class="flex space-x-2">
                        <button id="startCameraBtn" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300">
                            <i class="fa fa-play mr-2"></i>启动相机
                        </button>
                        <button id="stopCameraBtn" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300 disabled:opacity-50">
                            <i class="fa fa-stop mr-2"></i>停止相机
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 返回按钮 -->
        <div class="text-center">
            <a href="{{ url_for('operations') }}" 
               class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-6 rounded-full transition-colors duration-300">
                <i class="fa fa-arrow-left mr-2"></i>返回操作界面
            </a>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>© 深圳一目智能科技有限公司</p>
        </footer>
    </div>

    <!-- JavaScript 控制逻辑 -->
    <script>
        let isRunning = false;
        let statusInterval = null;
        let cameraStreaming = false;
        let cameraFrameCount = 0;
        let cameraStartTime = 0;

        // 获取DOM元素
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusBadge = document.getElementById('statusBadge');
        const statusMessage = document.getElementById('statusMessage');
        const lastUpdate = document.getElementById('lastUpdate');

        // 相机相关元素
        const cameraFrame = document.getElementById('cameraFrame');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const cameraStatus = document.getElementById('cameraStatus');
        const cameraFPS = document.getElementById('cameraFPS');
        const cameraLastUpdate = document.getElementById('cameraLastUpdate');

        // 获取Demo1状态
        function fetchStatus() {
            fetch('/api/demo1/status')
                .then(response => response.json())
                .then(data => {
                    updateStatus(data);
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                    statusMessage.textContent = '状态获取失败: ' + error.message;
                    statusBadge.textContent = '连接错误';
                    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-medium border status-error';
                });
        }

        // 更新状态显示
        function updateStatus(data) {
            const now = new Date().toLocaleTimeString();
            lastUpdate.textContent = now;
            
            statusMessage.textContent = data.message;
            statusBadge.textContent = data.status;
            
            // 更新状态样式
            statusBadge.className = 'px-3 py-1 rounded-full text-sm font-medium border ';
            if (data.running) {
                statusBadge.className += 'status-running';
            } else if (data.status === '错误' || data.status === '初始化失败') {
                statusBadge.className += 'status-error';
            } else if (data.status.includes('中')) {
                statusBadge.className += 'status-initializing';
            } else {
                statusBadge.className += 'status-stopped';
            }
            
            // 关键修复：Demo不在运行时，重置所有状态
            if (!data.running) {
                isRunning = false;
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fa fa-play mr-2"></i>启动 Demo1';
                stopBtn.disabled = true;
                
                // 停止轮询
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            } else {
                // Demo正在运行
                isRunning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
            }
        }

        // 重置启动按钮状态
        function resetStartButton() {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fa fa-play mr-2"></i>启动 Demo1';
        }

        // 启动Demo1
        function startDemo1() {
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>启动中...';
            
            fetch('/api/demo1/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 启动状态轮询
                        if (statusInterval) clearInterval(statusInterval);
                        statusInterval = setInterval(fetchStatus, 1000);
                        fetchStatus(); // 立即获取一次状态
                        
                        // 自动启动相机
                        startCamera();
                    } else {
                        alert('启动失败: ' + data.message);
                        resetStartButton();
                    }
                })
                .catch(error => {
                    console.error('启动失败:', error);
                    alert('启动失败: ' + error.message);
                    resetStartButton();
                });
        }

        // 停止Demo1
        function stopDemo1() {
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>停止中...';
            
            fetch('/api/demo1/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchStatus();
                        // 停止相机
                        stopCamera();
                    } else {
                        alert('停止失败: ' + data.message);
                    }
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>停止 Demo1';
                })
                .catch(error => {
                    console.error('停止失败:', error);
                    alert('停止失败: ' + error.message);
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>停止 Demo1';
                });
        }

        // 启动相机
        function startCamera() {
            if (cameraStreaming) return;
            
            cameraStreaming = true;
            cameraFrameCount = 0;
            cameraStartTime = Date.now();
            
            // 显示相机画面
            cameraFrame.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            
            // 更新状态
            cameraStatus.textContent = '已连接';
            startCameraBtn.disabled = true;
            stopCameraBtn.disabled = false;
            
            // 监听画面加载
            cameraFrame.onload = function() {
                cameraFrameCount++;
                const now = Date.now();
                const elapsed = (now - cameraStartTime) / 1000;
                const fps = elapsed > 0 ? (cameraFrameCount / elapsed).toFixed(1) : '0';
                cameraFPS.textContent = fps + ' fps';
                cameraLastUpdate.textContent = new Date().toLocaleTimeString();
            };
            
            cameraFrame.onerror = function() {
                cameraStatus.textContent = '连接错误';
                cameraFrame.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
            };
        }

        // 停止相机
        function stopCamera() {
            if (!cameraStreaming) return;
            
            cameraStreaming = false;
            
            // 隐藏相机画面
            cameraFrame.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            
            // 更新状态
            cameraStatus.textContent = '未连接';
            cameraFPS.textContent = '--';
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
        }

        // 事件监听
        startBtn.addEventListener('click', startDemo1);
        stopBtn.addEventListener('click', stopDemo1);
        refreshBtn.addEventListener('click', fetchStatus);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);

        // 页面加载时获取初始状态
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            
            // 如果Demo正在运行，启动轮询
            setTimeout(() => {
                if (isRunning) {
                    statusInterval = setInterval(fetchStatus, 1000);
                }
            }, 100);
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', () => {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>
